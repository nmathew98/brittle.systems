networks:
  default:
    name: sail
    driver: overlay
    attachable: true

services:
  setup:
    image: laravelsail/php81-composer
    command: composer install --ignore-platform-reqs
    volumes:
      - .:/var/www/html

  statamic:
    depends_on:
      - setup
    build:
      context: ./vendor/laravel/sail/runtimes/8.3
      dockerfile: Dockerfile
      args:
        WWWGROUP: ${WWWGROUP}
    image: sail-8.3/app
    extra_hosts:
      - host.docker.internal:host-gateway
    environment:
      WWWUSER: ${WWWUSER}
      LARAVEL_SAIL: 1
      XDEBUG_MODE: ${SAIL_XDEBUG_MODE:-off}
      XDEBUG_CONFIG: ${SAIL_XDEBUG_CONFIG:-client_host=host.docker.internal}
      IGNITION_LOCAL_SITES_PATH: ${PWD}
    volumes:
      - .:/var/www/html
    deploy:
      mode: replicated
      replicas: 1
    ulimits:
      soft: 20000
      hard: 20000
